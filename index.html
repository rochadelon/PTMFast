<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mistral OCR - PDF Extractor</title>
    <style>
        :root {
            --color-primary: #FF6B35;
            --color-dark: #1F2937;
            --color-light: #F3F4F6;
            --color-success: #10B981;
            --color-error: #EF4444;
            --color-border: #E5E7EB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 16px;
            min-height: 100vh;
            color: var(--color-dark);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: var(--color-primary);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .content {
            padding: 24px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--color-dark);
        }

        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 16px;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            grid-column: 1 / -1;
        }

        .btn-primary:hover:not(:disabled) {
            background: #E55A25;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--color-light);
            color: var(--color-dark);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #E5E7EB;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            margin-top: 10px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.loading {
            background: #DBEAFE;
            color: #1E40AF;
            border: 1px solid #BFDBFE;
        }

        .status.success {
            background: #DCFCE7;
            color: #166534;
            border: 1px solid #BBF7D0;
        }

        .status.error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FECACA;
        }

        .pdf-list {
            background: var(--color-light);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--color-border);
        }

        .pdf-item {
            padding: 10px;
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .pdf-item:last-child {
            border-bottom: none;
        }

        .pdf-item:hover {
            background: white;
        }

        .pdf-item input[type="radio"] {
            margin-right: 10px;
            cursor: pointer;
        }

        .pdf-name {
            flex: 1;
            word-break: break-word;
        }

        .output-section {
            background: var(--color-light);
            border-radius: 6px;
            padding: 12px;
            border: 1px solid var(--color-border);
            display: none;
        }

        .output-section.show {
            display: block;
        }

        .markdown-output {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 12px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 11px;
            max-height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
            margin-top: 10px;
        }

        .info-box {
            background: #F0F9FF;
            border: 1px solid #BFDBFE;
            border-radius: 6px;
            padding: 12px;
            font-size: 12px;
            color: #1E40AF;
            margin-bottom: 16px;
        }

        .divider {
            height: 1px;
            background: var(--color-border);
            margin: 20px 0;
        }

        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            .btn-primary {
                grid-column: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Mistral OCR</h1>
            <p>Extraia texto de PDFs em Markdown</p>
        </div>

        <div class="content">
            <!-- Configura√ß√£o da API Key -->
            <div class="section">
                <div class="section-title">‚öôÔ∏è Configura√ß√£o</div>
                <div class="info-box">
                    Obtenha sua chave gratuita em <strong>mistral.ai</strong> ‚Ä¢ Processamento: ~$0.001 por p√°gina
                </div>
                <div class="form-group">
                    <label for="apiKey">Chave API Mistral</label>
                    <input 
                        type="password" 
                        id="apiKey" 
                        placeholder="sk-..." 
                        autocomplete="off"
                    >
                    <small style="display: block; margin-top: 6px; color: #6B7280;">
                        Sua chave √© salva apenas localmente no navegador
                    </small>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Sele√ß√£o de PDF -->
            <div class="section">
                <div class="section-title">üìÑ PDFs Detectados</div>
                <div id="pdfCount" style="font-size: 12px; color: #6B7280; margin-bottom: 10px;">
                    Nenhum PDF encontrado
                </div>
                <div id="pdfList" class="pdf-list" style="display: none;">
                </div>
                <div id="noPdfMessage" style="font-size: 12px; color: #6B7280; padding: 12px; text-align: center;">
                    Abra uma p√°gina com PDFs (links ou incorporados)
                </div>
            </div>

            <!-- Status -->
            <div id="status" class="status"></div>

            <!-- Bot√µes de a√ß√£o -->
            <div class="button-group">
                <button class="btn-secondary" id="btnRefresh">üîÑ Atualizar</button>
                <button class="btn-primary" id="btnProcess" disabled>
                    ‚ö° Processar com OCR
                </button>
            </div>

            <div class="divider"></div>

            <!-- Sa√≠da Markdown -->
            <div class="section">
                <div class="section-title">üìã Resultado Markdown</div>
                <div id="outputSection" class="output-section">
                    <div id="markdownOutput" class="markdown-output"></div>
                    <div class="button-group" style="margin-top: 12px;">
                        <button class="btn-secondary" id="btnCopy">üìã Copiar</button>
                        <button class="btn-secondary" id="btnDownload">‚¨áÔ∏è Download</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ======================
        // Estado da Extens√£o
        // ======================
        const state = {
            apiKey: localStorage.getItem('mistralApiKey') || '',
            pdfs: [],
            selectedPdf: null,
            currentMarkdown: ''
        };

        const elements = {
            apiKey: document.getElementById('apiKey'),
            pdfList: document.getElementById('pdfList'),
            pdfCount: document.getElementById('pdfCount'),
            noPdfMessage: document.getElementById('noPdfMessage'),
            status: document.getElementById('status'),
            outputSection: document.getElementById('outputSection'),
            markdownOutput: document.getElementById('markdownOutput'),
            btnRefresh: document.getElementById('btnRefresh'),
            btnProcess: document.getElementById('btnProcess'),
            btnCopy: document.getElementById('btnCopy'),
            btnDownload: document.getElementById('btnDownload')
        };

        // ======================
        // Fun√ß√µes Utilit√°rias
        // ======================
        const showStatus = (message, type = 'loading') => {
            elements.status.textContent = type === 'loading' ? '‚è≥ ' + message : 
                                          type === 'success' ? '‚úÖ ' + message : 
                                          '‚ùå ' + message;
            elements.status.className = `status show ${type}`;
        };

        const hideStatus = () => {
            elements.status.className = 'status';
        };

        const saveApiKey = () => {
            state.apiKey = elements.apiKey.value.trim();
            localStorage.setItem('mistralApiKey', state.apiKey);
        };

        // ======================
        // Detec√ß√£o de PDFs
        // ======================
        const detectPdfs = async () => {
            showStatus('Detectando PDFs na p√°gina...');
            
            try {
                const response = await chrome.tabs.query({ active: true, currentWindow: true });
                const tab = response[0];

                const pdfs = await chrome.tabs.executeScript(tab.id, {
                    code: `
                        (function() {
                            const pdfLinks = [];
                            
                            // Detecta <a> tags com href .pdf
                            document.querySelectorAll('a[href*=".pdf"]').forEach(link => {
                                pdfLinks.push({
                                    name: link.textContent?.trim() || link.href.split('/').pop(),
                                    url: link.href
                                });
                            });
                            
                            // Detecta <embed> e <iframe> com src .pdf
                            document.querySelectorAll('embed[src*=".pdf"], iframe[src*=".pdf"]').forEach(elem => {
                                pdfLinks.push({
                                    name: elem.src.split('/').pop(),
                                    url: elem.src
                                });
                            });
                            
                            // Remove duplicatas
                            const unique = Array.from(new Map(
                                pdfLinks.map(p => [p.url, p])
                            ).values());
                            
                            return unique;
                        })();
                    `
                });

                state.pdfs = pdfs[0] || [];
                renderPdfList();
                hideStatus();
            } catch (err) {
                showStatus('Erro ao detectar PDFs: ' + err.message, 'error');
            }
        };

        // ======================
        // Renderiza√ß√£o da UI
        // ======================
        const renderPdfList = () => {
            if (state.pdfs.length === 0) {
                elements.pdfCount.textContent = 'Nenhum PDF encontrado';
                elements.pdfList.style.display = 'none';
                elements.noPdfMessage.style.display = 'block';
                elements.btnProcess.disabled = true;
                return;
            }

            elements.pdfCount.textContent = `${state.pdfs.length} PDF(s) encontrado(s)`;
            elements.pdfList.style.display = 'block';
            elements.noPdfMessage.style.display = 'none';
            elements.pdfList.innerHTML = state.pdfs.map((pdf, idx) => `
                <label class="pdf-item">
                    <input 
                        type="radio" 
                        name="selectedPdf" 
                        value="${idx}"
                        ${state.selectedPdf === idx ? 'checked' : ''}
                    >
                    <span class="pdf-name">${escapeHtml(pdf.name)}</span>
                </label>
            `).join('');

            document.querySelectorAll('input[name="selectedPdf"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    state.selectedPdf = parseInt(e.target.value);
                    elements.btnProcess.disabled = !state.apiKey || state.selectedPdf === null;
                });
            });

            if (state.selectedPdf === null && state.pdfs.length > 0) {
                state.selectedPdf = 0;
                elements.btnProcess.disabled = !state.apiKey;
            }
        };

        // ======================
        // Processamento OCR
        // ======================
        const processPdf = async () => {
            if (!state.apiKey) {
                showStatus('Configure sua chave API antes', 'error');
                return;
            }

            if (state.selectedPdf === null) {
                showStatus('Selecione um PDF', 'error');
                return;
            }

            const pdfUrl = state.pdfs[state.selectedPdf].url;
            showStatus('Processando PDF com Mistral OCR...');
            elements.btnProcess.disabled = true;

            try {
                const response = await fetch('https://api.mistral.ai/v1/ocr', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'mistral-ocr-latest',
                        document: {
                            type: 'document_url',
                            document_url: pdfUrl
                        },
                        include_image_base64: false
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `API Error: ${response.status}`);
                }

                const data = await response.json();
                state.currentMarkdown = data.content || 'Nenhum conte√∫do extra√≠do';
                
                elements.markdownOutput.textContent = state.currentMarkdown;
                elements.outputSection.classList.add('show');
                
                showStatus(`‚ú® Sucesso! ${Math.round(state.currentMarkdown.length / 1000)}KB extra√≠do`, 'success');
                
                setTimeout(() => hideStatus(), 3000);
            } catch (err) {
                showStatus('Erro: ' + err.message, 'error');
            } finally {
                elements.btnProcess.disabled = false;
            }
        };

        // ======================
        // A√ß√µes de Download/C√≥pia
        // ======================
        const copyToClipboard = () => {
            navigator.clipboard.writeText(state.currentMarkdown).then(() => {
                showStatus('‚úÖ Copiado para √°rea de transfer√™ncia', 'success');
                setTimeout(hideStatus, 2000);
            }).catch(() => {
                showStatus('Erro ao copiar', 'error');
            });
        };

        const downloadMarkdown = () => {
            const pdfName = state.pdfs[state.selectedPdf].name.replace('.pdf', '');
            const blob = new Blob([state.currentMarkdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${pdfName}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // ======================
        // Utilit√°rios
        // ======================
        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        // ======================
        // Event Listeners
        // ======================
        elements.apiKey.value = state.apiKey;
        elements.apiKey.addEventListener('change', saveApiKey);

        elements.btnRefresh.addEventListener('click', detectPdfs);
        elements.btnProcess.addEventListener('click', processPdf);
        elements.btnCopy.addEventListener('click', copyToClipboard);
        elements.btnDownload.addEventListener('click', downloadMarkdown);

        // Inicializa√ß√£o
        window.addEventListener('load', detectPdfs);
    </script>
</body>
</html>
